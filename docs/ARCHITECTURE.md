# Архитектура проекта AI Client Report Generator

## Общая концепция

Проект представляет собой CLI-приложение на Python для автоматической генерации PDF-отчётов по диалогам с клиентами. Основная идея - быстрая обработка транскриптов через AI с возможностью гибкой настройки шаблонов отчётов.

## Принципы проектирования

1. **Модульность** - каждый компонент системы изолирован и выполняет одну задачу
2. **Расширяемость** - легко добавлять новые поля в отчёт или менять шаблоны
3. **Устойчивость** - обработка всех возможных ошибок с понятными сообщениями
4. **Прозрачность** - детальное логирование всех операций
5. **Эффективность** - кэширование для экономии времени и средств

## Архитектурные слои

```
┌─────────────────────────────────────────────────────────┐
│                    CLI Interface                        │
│                     (main.py)                           │
└─────────────────────────────────────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────────┐
│                  Business Logic Layer                   │
├─────────────────────────────────────────────────────────┤
│  ai_processor.py    │  pdf_generator.py  │  schema.py  │
│  - AI обработка     │  - HTML рендеринг  │  - Схемы    │
│  - Кэширование      │  - PDF генерация   │  - Валидация│
│  - Retry логика     │  - Jinja2          │  - Pydantic │
└─────────────────────────────────────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────────┐
│                   Infrastructure Layer                  │
├─────────────────────────────────────────────────────────┤
│   io.py             │  logging_setup.py  │  config.py  │
│   - Файловые I/O    │  - Настройка       │  - Env vars │
│   - JSON работа     │    логирования     │  - Константы│
│   - Атомарная       │  - Форматирование  │  - Валидация│
│     запись          │                    │              │
└─────────────────────────────────────────────────────────┘
```

## Потоки данных

### Основной поток генерации отчёта

```
Транскрипт (txt)
    │
    ▼
[Чтение файла] (io.py)
    │
    ▼
[Вычисление hash] (ai_processor.py)
    │
    ▼
[Проверка кэша] ──[CACHE HIT]──> [Загрузка из кэша]
    │                                     │
    │ [CACHE MISS]                       │
    ▼                                     │
[OpenAI API вызов] ◄──[retry]──┐         │
    │                           │         │
    ▼                           │         │
[Парсинг JSON] ──[INVALID]─────┘         │
    │                                     │
    │ [VALID]                             │
    ▼                                     │
[Pydantic валидация] ◄──────────────────┘
    │
    ▼
[Сохранение в кэш] (если включён)
    │
    ▼
[Рендеринг HTML] (jinja2)
    │
    ▼
[Конвертация в PDF] (weasyprint)
    │
    ▼
PDF отчёт
```

## Модули

### main.py
**Назначение**: Точка входа, CLI интерфейс

**Ответственность**:
- Парсинг аргументов командной строки
- Координация работы всех компонентов
- Обработка ошибок верхнего уровня
- Вывод пользовательских сообщений

**Зависимости**: config, utils.*

### config.py
**Назначение**: Централизованная конфигурация

**Ответственность**:
- Загрузка .env переменных
- Валидация обязательных настроек (API key)
- Определение констант и путей
- Создание необходимых директорий

**Зависимости**: python-dotenv

### utils/schema.py
**Назначение**: Схемы данных

**Ответственность**:
- Определение структуры ReportData
- Валидация данных через Pydantic
- Документация схемы для AI промптов

**Зависимости**: pydantic

**Ключевые типы**:
```python
Sentiment:
  - label: str
  - score: int (1-5)

ReportData:
  - client_name: str
  - topic: str
  - main_request: str
  - sentiment: Sentiment
  - summary: str
  - key_points: List[str]
  - next_steps: List[str]
```

### utils/io.py
**Назначение**: Работа с файлами

**Ответственность**:
- Чтение текстовых файлов с обработкой ошибок
- Чтение/запись JSON
- Атомарная запись через temp файлы
- Генерация путей для кэша

**Зависимости**: pathlib, json, tempfile

### utils/logging_setup.py
**Назначение**: Настройка логирования

**Ответственность**:
- Конфигурация логгера (консоль + файл)
- Форматирование сообщений
- Управление уровнями логирования

**Зависимости**: logging

### utils/ai_processor.py
**Назначение**: Взаимодействие с OpenAI API

**Ответственность**:
- Вызов OpenAI Chat Completions API
- Кэширование ответов (hash-based)
- Retry логика для невалидных ответов
- Парсинг и валидация JSON
- Обработка специфичных ошибок API

**Зависимости**: openai, hashlib, schema, io

**Стратегия retry**:
1. Первый запрос к API
2. Если JSON невалиден → correction prompt (до 2 раз)
3. Если всё равно невалиден → ошибка

**Обработка ошибок**:
- APIConnectionError → "Проблемы с сетью"
- RateLimitError → "Превышен лимит запросов"
- APITimeoutError → "Таймаут запроса"
- ValidationError → Retry логика

### utils/pdf_generator.py
**Назначение**: Генерация PDF отчётов

**Ответственность**:
- Рендеринг HTML через Jinja2
- Конвертация HTML → PDF через WeasyPrint
- Обработка ошибок шаблонов
- Валидация созданных PDF

**Зависимости**: jinja2, weasyprint, schema

**Поток**:
1. Загрузка CSS
2. Загрузка HTML шаблона
3. Рендеринг с контекстом (report_data + meta)
4. Конвертация в PDF
5. Проверка размера файла

## Управление состоянием

Приложение является **stateless** - каждый запуск независим:
- Нет базы данных
- Нет сессий
- Состояние между запусками сохраняется только через:
  - Кэш файлы (cache/ai_outputs/)
  - Логи (logs/app.log)
  - Сгенерированные PDF (reports/)

## Кэширование

**Стратегия**: Content-based caching через SHA256

```
hash = sha256(transcript_text)
cache_path = cache/ai_outputs/{hash}.json
```

**Преимущества**:
- Одинаковые транскрипты → один кэш файл
- Автоматическая инвалидация при изменении текста
- Детерминированность
- Экономия API вызовов

**Атомарность**:
Запись через temp файл + rename для предотвращения повреждения при сбое

## Обработка ошибок

### Уровни обработки:

1. **Infrastructure** (io.py):
   - FileNotFoundError
   - UnicodeDecodeError
   - json.JSONDecodeError

2. **Business Logic** (ai_processor.py, pdf_generator.py):
   - OpenAI API errors
   - ValidationError
   - TemplateNotFound
   - WeasyPrint errors

3. **Application** (main.py):
   - Координация обработки
   - User-friendly сообщения
   - Exit codes

### Принципы:
- **Fail-fast** для критичных ошибок
- **Retry** для нестабильных операций (AI парсинг)
- **Logging** всех ошибок в файл
- **Clear messages** для пользователя

## Расширяемость

### Добавление новых полей в отчёт:

1. Обновить `ReportData` в `schema.py`
2. Обновить `REPORT_SCHEMA_DESCRIPTION`
3. Обновить AI prompt в `ai_processor.py`
4. Обновить HTML шаблон
5. При необходимости обновить CSS

### Добавление новых источников данных:

Создать новый reader в `io.py` или новый модуль:
```python
def read_audio_transcript(audio_path: Path) -> str:
    # Интеграция с Whisper или другим ASR
    pass
```

### Добавление новых форматов вывода:

Создать новый generator в utils/:
```python
def generate_docx_report(report_data: ReportData, ...):
    # Генерация DOCX через python-docx
    pass
```

## Безопасность

### Текущие меры:

1. **API Keys**: Хранение в .env, не в коде
2. **.gitignore**: Исключение .env из git
3. **Validation**: Строгая валидация всех входных данных
4. **Sandboxing**: Jinja2 с автоэскейпингом
5. **Logging**: Не логируем sensitive данные (API keys)

### Потенциальные улучшения:

1. Rate limiting для API вызовов
2. Шифрование кэш файлов
3. Валидация размера входных файлов
4. Sandbox для WeasyPrint (системные вызовы)

## Производительность

### Оптимизации:

1. **Кэширование** - основная оптимизация
2. **Атомарная запись** - предотвращение блокировок
3. **Streaming** - не используется (файлы обычно небольшие)
4. **Параллелизм** - не требуется для CLI

### Узкие места:

1. **OpenAI API** - зависит от сети и лимитов
2. **WeasyPrint** - CPU-интенсивная операция
3. **Большие транскрипты** - ограничение токенов API

### Масштабирование:

Текущая архитектура оптимальна для:
- CLI использования
- Одиночные запросы
- Средние объёмы (до 100К символов транскрипта)

Для масштабирования потребуется:
- Добавление очередей (Celery, RQ)
- API wrapper (Flask/FastAPI)
- Batch processing
- Distributed caching (Redis)

## Тестирование

### Рекомендуемая структура тестов:

```
tests/
├── unit/
│   ├── test_schema.py      # Pydantic валидация
│   ├── test_io.py          # Файловые операции
│   └── test_cache.py       # Кэширование
├── integration/
│   ├── test_ai_processor.py  # Моки OpenAI
│   └── test_pdf_generator.py # Рендеринг
└── e2e/
    └── test_full_flow.py   # Полный пайплайн
```

### Стратегия:

1. **Unit тесты**: Изолированное тестирование функций
2. **Integration**: Тестирование связей между модулями
3. **E2E**: Полный флоу с фикстурами
4. **Mocking**: OpenAI API, файловая система

## Зависимости

### Прямые зависимости:

- **openai**: API client
- **jinja2**: Шаблонизация
- **weasyprint**: PDF генерация
- **python-dotenv**: Конфигурация
- **pydantic**: Валидация

### Системные зависимости:

- **WeasyPrint требует**: Cairo, Pango, GDK-PixBuf
- **Платформозависимость**: Windows/Linux/macOS

## Будущие улучшения

### Потенциальные фичи:

1. **Web интерфейс** (Flask/FastAPI)
2. **Batch processing** для множества файлов
3. **Мультиязычность** отчётов
4. **Кастомные AI промпты** через конфиг
5. **Экспорт в другие форматы** (DOCX, HTML, Markdown)
6. **Сравнение отчётов** (diff)
7. **Статистика** по всем отчётам
8. **Integration с CRM** системами

### Технический долг:

На данный момент отсутствует - проект создан с нуля.

## Вклад в проект

При добавлении новых фич следовать принципам:

1. Модульность - новый функционал в отдельном модуле
2. Обратная совместимость - не ломать существующий API
3. Документация - обновлять README и ARCHITECTURE
4. Логирование - добавлять информативные логи
5. Обработка ошибок - понятные сообщения пользователю
6. Тестирование - покрытие новых модулей

## Changelog

Все изменения фиксировать в `docs/CHANGELOG.md` по формату:

```
## [X.Y.Z] - YYYY-MM-DD
### Добавлено / Изменено / Исправлено / Удалено
```
